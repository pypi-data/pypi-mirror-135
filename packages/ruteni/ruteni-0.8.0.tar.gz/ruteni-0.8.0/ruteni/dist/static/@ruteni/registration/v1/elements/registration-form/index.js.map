{"version":3,"file":"index.js.map","sources":["../../../../../../../apps/registration/js/elements/registration-form/resources.js","../../../../../../../apps/registration/js/elements/registration-form/index.js"],"sourcesContent":["export default {\"@ruteni/blaze/v1\":{\"components.buttons\":\"/static/@ruteni/blaze/v1/css/components.buttons.css\",\"components.hints\":\"/static/@ruteni/blaze/v1/css/components.hints.css\",\"components.inputs\":\"/static/@ruteni/blaze/v1/css/components.inputs.css\",\"components.links\":\"/static/@ruteni/blaze/v1/css/components.links.css\",\"generics.global\":\"/static/@ruteni/blaze/v1/css/generics.global.css\",\"objects.containers\":\"/static/@ruteni/blaze/v1/css/objects.containers.css\",\"objects.forms\":\"/static/@ruteni/blaze/v1/css/objects.forms.css\",\"objects.images\":\"/static/@ruteni/blaze/v1/css/objects.images.css\",\"utilities.boxing\":\"/static/@ruteni/blaze/v1/css/utilities.boxing.css\",\"utilities.sizes\":\"/static/@ruteni/blaze/v1/css/utilities.sizes.css\",\"utilities.typography\":\"/static/@ruteni/blaze/v1/css/utilities.typography.css\",\"utilities.visibility\":\"/static/@ruteni/blaze/v1/css/utilities.visibility.css\",\"variables.host\":\"/static/@ruteni/blaze/v1/css/variables.host.css\"}}","import logging from \"external:@ruteni/logging/v1\";\nimport blaze from \"external:@ruteni/blaze/v1\";\nimport { getLanguage, registerElementBundleResolver } from \"external:@ruteni/translation/v1\";\nimport sanitizer from \"external:@ruteni/security/v1\";\nimport QuotquotElement from \"external:@ruteni/quotquot/v1:element\";\nimport EventsPlugin from \"external:@ruteni/quotquot/v1:plugin.events\";\nimport FluentPlugin from \"external:@ruteni/quotquot/v1:plugin.fluent\";\nimport StylePlugin from \"external:@ruteni/quotquot/v1:plugin.style\";\nimport ClassPlugin from \"external:@ruteni/quotquot/v1:plugin.class\";\n// import TemplatePlugin from \"external:@ruteni/quotquot/v1:plugin.template\";\nimport { io } from \"external:@ruteni/socket.io-client/v1\";\n\nimport html from \"./index.html\";\nimport index from \"./index.json\";\nimport resources from \"./resources.js\";\n\nconst logger = logging.getLogger(\"ruteni.plugin.registration.element.form\");\n// logger.setLevel(\"WARN\");\n\nregisterElementBundleResolver(index, import.meta.url);\n\nclass TimeoutError extends Error {\n    constructor(args, timeout) {\n        super(`${args[0]} timed out after ${timeout} milliseconds`);\n        this.args = args;\n        this.timeout = timeout;\n    }\n}\n\nsanitizer.addCustomElement(index.tagName);\nconst template = document.createElement(\"template\");\ntemplate.innerHTML = sanitizer.sanitize(html);\n\n// TODO: use logo custom element from site component\n\nclass RegistrationFormHTMLElement extends QuotquotElement {\n    constructor() {\n        const state = {\n            minutes: -1,\n            remaining: -1,\n            issues: {},\n            state: \"editing\",\n            styles: blaze.getUrls(index, resources),\n            events: {\n                \"submit-form\": e => {\n                    e.preventDefault();\n                    logger.debug(\"submit-form\");\n                    this.submit().catch(logger.error);\n                },\n                \"verify-code\": e => {\n                    e.preventDefault();\n                    this.verify().catch(logger.error);\n                },\n                \"back-home\": e => this.update({ state: \"editing\" }).catch(logger.error)\n            }\n        };\n        super({\n            template,\n            state,\n            Plugins: [ClassPlugin, EventsPlugin, FluentPlugin, StylePlugin/*, TemplatePlugin*/]\n        });\n        this._socket = io(\"/ruteni/registration\", { transports: [\"websocket\"] });\n        this._socket.on(\"connect\", () => logger.debug(\"connected\"));\n        this._socket.on(\"disconnect\", reason => logger.debug(\"disconnected\", reason));\n        this._socket.on(\"connect_error\", logger.error);\n    }\n\n    /*\n    connectedCallback() {\n        super.connectedCallback();\n        connectRoot(componentName, this.shadowRoot);\n        translateFragment(componentName, this.shadowRoot).catch(logger.error);\n        logger.debug(`added ${index.tagName} to ${componentName} localization`);\n    }\n\n    disconnectedCallback() {\n        super.connectedCallback();\n        disconnectRoot(componentName, this.shadowRoot);\n        logger.debug(`removed ${index.tagName} from ${componentName} localization`);\n    }\n    */\n\n    call(timeout, ...args) {\n        let timeoutId;\n        return Promise.race([\n            new Promise(resolve => this._socket.emit(...args, result => {\n                clearTimeout(timeoutId); // TODO: race condition on timeoutId?\n                resolve(result);\n            })),\n            new Promise((resolve, reject) => {\n                timeoutId = setTimeout(() => {\n                    const error = new TimeoutError(args, timeout);\n                    reject(error);\n                }, timeout);\n            })\n        ]);\n    }\n\n    async submit() {\n        // logger.debug(displayName.validity);\n        // const form = this.shadowRoot.forms.register;\n        const form = this.$('form[name=\"register\"]');\n        const { displayName, email, password, passwordCheck } = form.elements;\n        try {\n            var issues = await this.call(5000, \"edit\", { // eslint-disable-line no-var\n                display_name: displayName.value, // eslint-disable-line camelcase\n                email: email.value,\n                password: password.value,\n                locale: getLanguage()\n            });\n        }\n        catch (exc) {\n            if (exc instanceof TimeoutError)\n                await this.update({ issues: { \"server-timeout\": true } });\n            logger.error(exc);\n            return;\n        }\n\n        if (password.value !== passwordCheck.value)\n            issues[\"password-mismatch\"] = true;\n\n        if (Object.keys(issues).length)\n            await this.update({ issues });\n        else\n            await this.register();\n    }\n\n    async register() {\n        try {\n            var minutes = await this.call(5000, \"register\"); // eslint-disable-line no-var\n        }\n        catch (exc) {\n            if (exc instanceof TimeoutError)\n                await this.update({ issues: { \"server-timeout\": true } });\n            logger.error(exc);\n            return;\n        }\n\n        if (minutes)\n            await this.update({ state: \"delivered\", minutes });\n        else\n            await this.update({ state: \"delivery-failed\" });\n    }\n\n    async verify() {\n        const form = this.$('form[name=\"verify\"]');\n        const code = form.elements.verificationCode.value;\n        form.elements.verificationCode.value = \"\";\n        try {\n            var result = await this.call(5000, \"verify\", code); // eslint-disable-line no-var\n        }\n        catch (exc) {\n            if (exc instanceof TimeoutError)\n                await this.update({ issues: { \"server-timeout\": true } });\n            logger.error(exc);\n            return;\n        }\n\n        // TODO: manage {error: \"invalid-arguments\"}\n        if (result === null) {\n            this._socket.disconnect();\n            await this.update({ state: \"confirmed\" });\n            const event = new window.CustomEvent(\"registered\", { detail: null });\n            this.dispatchEvent(event);\n        }\n        else if (result === -1)\n            await this.update({ state: \"code-expired\" });\n        else if (result === 0)\n            await this.update({ state: \"too-many-attempts\" });\n        else if (result > 0)\n            await this.update({ remaining: result });\n        else\n            logger.error(result); // TODO: notify user\n    }\n\n}\n\nwindow.customElements.define(index.tagName, RegistrationFormHTMLElement);\n"],"names":["logger","logging","getLogger","registerElementBundleResolver","index","import","meta","url","TimeoutError","Error","constructor","args","timeout","super","this","sanitizer","addCustomElement","tagName","template","document","createElement","innerHTML","sanitize","window","customElements","define","QuotquotElement","state","minutes","remaining","issues","styles","blaze","getUrls","resources","events","e","preventDefault","debug","submit","catch","error","verify","update","Plugins","ClassPlugin","EventsPlugin","FluentPlugin","StylePlugin","_socket","io","transports","on","reason","call","timeoutId","Promise","race","resolve","emit","result","clearTimeout","reject","setTimeout","async","form","$","displayName","email","password","passwordCheck","elements","display_name","value","locale","getLanguage","exc","Object","keys","length","register","code","verificationCode","disconnect","event","CustomEvent","detail","dispatchEvent"],"mappings":"gmCAAe,CAAC,mBAAmB,CAAC,qBAAqB,sDAAsD,mBAAmB,oDAAoD,oBAAoB,qDAAqD,mBAAmB,oDAAoD,kBAAkB,mDAAmD,qBAAqB,sDAAsD,gBAAgB,iDAAiD,iBAAiB,kDAAkD,mBAAmB,oDAAoD,kBAAkB,mDAAmD,uBAAuB,wDAAwD,uBAAuB,wDAAwD,iBAAiB,oDCgBr5B,MAAMA,EAASC,EAAQC,UAAU,2CAGjCC,EAA8BC,EAAOC,OAAOC,KAAKC,KAEjD,MAAMC,UAAqBC,MACvBC,YAAYC,EAAMC,GACdC,MAAM,GAAGF,EAAK,sBAAsBC,kBACpCE,KAAKH,KAAOA,EACZG,KAAKF,QAAUA,GAIvBG,EAAUC,iBAAiBZ,EAAMa,SACjC,MAAMC,EAAWC,SAASC,cAAc,YACxCF,EAASG,UAAYN,EAAUO,2jMAkJ/BC,OAAOC,eAAeC,OAAOrB,EAAMa,QA9InC,cAA0CS,EACtChB,cACI,MAAMiB,EAAQ,CACVC,SAAU,EACVC,WAAY,EACZC,OAAQ,GACRH,MAAO,UACPI,OAAQC,EAAMC,QAAQ7B,EAAO8B,GAC7BC,OAAQ,CACJ,cAAeC,IACXA,EAAEC,iBACFrC,EAAOsC,MAAM,eACbxB,KAAKyB,SAASC,MAAMxC,EAAOyC,QAE/B,cAAeL,IACXA,EAAEC,iBACFvB,KAAK4B,SAASF,MAAMxC,EAAOyC,QAE/B,YAAaL,GAAKtB,KAAK6B,OAAO,CAAEhB,MAAO,YAAaa,MAAMxC,EAAOyC,SAGzE5B,MAAM,CACFK,SAAAA,EACAS,MAAAA,EACAiB,QAAS,CAACC,EAAaC,EAAcC,EAAcC,KAEvDlC,KAAKmC,QAAUC,EAAG,uBAAwB,CAAEC,WAAY,CAAC,eACzDrC,KAAKmC,QAAQG,GAAG,WAAW,IAAMpD,EAAOsC,MAAM,eAC9CxB,KAAKmC,QAAQG,GAAG,cAAcC,GAAUrD,EAAOsC,MAAM,eAAgBe,KACrEvC,KAAKmC,QAAQG,GAAG,gBAAiBpD,EAAOyC,OAkB5Ca,KAAK1C,KAAYD,GACb,IAAI4C,EACJ,OAAOC,QAAQC,KAAK,CAChB,IAAID,SAAQE,GAAW5C,KAAKmC,QAAQU,QAAQhD,GAAMiD,IAC9CC,aAAaN,GACbG,EAAQE,QAEZ,IAAIJ,SAAQ,CAACE,EAASI,KAClBP,EAAYQ,YAAW,KACnB,MAAMtB,EAAQ,IAAIjC,EAAaG,EAAMC,GACrCkD,EAAOrB,KACR7B,QAKfoD,eAGI,MAAMC,EAAOnD,KAAKoD,EAAE,0BACdC,YAAEA,EAAWC,MAAEA,EAAKC,SAAEA,EAAQC,cAAEA,GAAkBL,EAAKM,SAC7D,IACI,IAAIzC,QAAehB,KAAKwC,KAAK,IAAM,OAAQ,CACvCkB,aAAcL,EAAYM,MAC1BL,MAAOA,EAAMK,MACbJ,SAAUA,EAASI,MACnBC,OAAQC,MAGhB,MAAOC,GAIH,OAHIA,aAAepE,SACTM,KAAK6B,OAAO,CAAEb,OAAQ,CAAE,kBAAkB,UACpD9B,EAAOyC,MAAMmC,GAIbP,EAASI,QAAUH,EAAcG,QACjC3C,EAAO,sBAAuB,GAE9B+C,OAAOC,KAAKhD,GAAQiD,aACdjE,KAAK6B,OAAO,CAAEb,OAAAA,UAEdhB,KAAKkE,WAGnBhB,iBACI,IACI,IAAIpC,QAAgBd,KAAKwC,KAAK,IAAM,YAExC,MAAOsB,GAIH,OAHIA,aAAepE,SACTM,KAAK6B,OAAO,CAAEb,OAAQ,CAAE,kBAAkB,UACpD9B,EAAOyC,MAAMmC,GAIbhD,QACMd,KAAK6B,OAAO,CAAEhB,MAAO,YAAaC,QAAAA,UAElCd,KAAK6B,OAAO,CAAEhB,MAAO,oBAGnCqC,eACI,MAAMC,EAAOnD,KAAKoD,EAAE,uBACde,EAAOhB,EAAKM,SAASW,iBAAiBT,MAC5CR,EAAKM,SAASW,iBAAiBT,MAAQ,GACvC,IACI,IAAIb,QAAe9C,KAAKwC,KAAK,IAAM,SAAU2B,GAEjD,MAAOL,GAIH,OAHIA,aAAepE,SACTM,KAAK6B,OAAO,CAAEb,OAAQ,CAAE,kBAAkB,UACpD9B,EAAOyC,MAAMmC,GAKjB,GAAe,OAAXhB,EAAiB,CACjB9C,KAAKmC,QAAQkC,mBACPrE,KAAK6B,OAAO,CAAEhB,MAAO,cAC3B,MAAMyD,EAAQ,IAAI7D,OAAO8D,YAAY,aAAc,CAAEC,OAAQ,OAC7DxE,KAAKyE,cAAcH,QAEF,IAAZxB,QACC9C,KAAK6B,OAAO,CAAEhB,MAAO,iBACX,IAAXiC,QACC9C,KAAK6B,OAAO,CAAEhB,MAAO,sBACtBiC,EAAS,QACR9C,KAAK6B,OAAO,CAAEd,UAAW+B,IAE/B5D,EAAOyC,MAAMmB"}