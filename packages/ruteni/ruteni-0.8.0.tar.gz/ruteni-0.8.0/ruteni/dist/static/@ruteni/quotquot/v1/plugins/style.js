import e from"/static/@ruteni/logging/v1/index.js";const s=e.getLogger("@quotquot/style"),t=new class{constructor(){this.sheets={}}addSheet(e){if(!e)throw new Error("addSheet: null argument");let t=this.sheets[e];if(t)return t.promise?(s.debug(`stylesheet ${e} is loading`),t.promise.then((()=>(t.refcount++,s.debug(`stylesheet ${e} is loaded (${t.refcount})`),t.sheet)))):(t.refcount++,s.debug(`stylesheet ${e} is cached (${t.refcount})`),Promise.resolve(t.sheet));const o=new CSSStyleSheet;this.sheets[e]=t={sheet:o,refcount:0};const n=fetch(e).then((e=>e.text())).then((e=>o.replace(e))).then((()=>(t.refcount++,s.debug(`stylesheet ${e} is fetched (${t.refcount})`),delete t.promise,o)));return n.catch((s=>delete this.sheets[e])),t.promise=n,n}async release(e){const t=this.sheets[e];t&&!t.promise?(t.refcount--,0===t.refcount&&(s.debug(`removing stylesheet ${e}`),delete this.sheets[e])):s.warn(`unknown stylesheet ${e}`)}},o="adoptedStyleSheets"in document;s.debug(`adoptedStyleSheets ${o?"":"not "}supported`);var n=o?class{constructor(e){this.sheets=new Map}async setup(e){await this._syncStyles(e.shadowRoot,e.state.styles)}async cleanup(e){for(const e of this.sheets.keys())t.release(e);e.shadowRoot.adoptedStyleSheets=[],this.sheets.clear()}async onBeforeUpdate(e,s){s.styles&&await this._syncStyles(e.shadowRoot,s.styles)}async _syncStyles(e,o){for(const e of this.sheets.keys())-1===o.indexOf(e)&&(s.debug(`removing style ${e}`),t.release(e),this.sheets.delete(e));for(const n of o)n?this.sheets.has(n)||(s.debug(`adding style ${n}`),this.sheets.set(n,await t.addSheet(n))):s.error(`component ${e.host.tagName} has null style url`);e.adoptedStyleSheets=this.sheets.values()}}:class{constructor(e){this.links=new Map}async setup(e){this._syncStyles(e.shadowRoot,e.state.styles)}async cleanup(e){for(const s of this.links.values())e.shadowRoot.removeChild(s);this.links.clear()}async onBeforeUpdate(e,s){s.styles&&this._syncStyles(e.shadowRoot,s.styles)}_syncStyles(e,t){for(const o of this.links.keys())-1===t.indexOf(o)&&(s.debug(`removing style ${o}`),e.removeChild(this.links.get(o)),this.links.delete(o));for(const e of t)if(!this.links.has(e)){s.debug(`adding style ${e}`);const t=document.createElement("link");t.rel="stylesheet",t.href=e,this.links.set(e,t)}for(const s of Array.from(t).reverse())e.insertBefore(this.links.get(s),e.firstChild)}};export{n as default};
