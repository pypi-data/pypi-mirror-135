import e from"/static/@ruteni/logging/v1/index.js";import i from"/static/@ruteni/blaze/v1/index.js";import{registerElementBundleResolver as t,getLanguage as a}from"/static/@ruteni/translation/v1/index.js";import s from"/static/@ruteni/security/v1/index.js";import n from"/static/@ruteni/quotquot/v1/element.js";import l from"/static/@ruteni/quotquot/v1/plugins/events.js";import d from"/static/@ruteni/quotquot/v1/plugins/fluent.js";import o from"/static/@ruteni/quotquot/v1/plugins/style.js";import c from"/static/@ruteni/quotquot/v1/plugins/class.js";import{io as r}from"/static/@ruteni/socket.io-client/v1/index.js";var u={tagName:"registration-form",module:"index.js",languages:["en-US","fr-FR"],resources:{style:["index.css","text/css"],fluent:[{"lang=en-US":"locales/en-US.ftl","lang=fr-FR":"locales/fr-FR.ftl"},"text/x-fluent"]},select:{"@ruteni/blaze/v1":["variables.host","generics.global","components.buttons","components.hints","components.inputs","components.links","objects.containers","objects.forms","objects.images","utilities.boxing","utilities.sizes","utilities.typography","utilities.visibility"]}},m={"@ruteni/blaze/v1":{"components.buttons":"/static/@ruteni/blaze/v1/css/components.buttons.css","components.hints":"/static/@ruteni/blaze/v1/css/components.hints.css","components.inputs":"/static/@ruteni/blaze/v1/css/components.inputs.css","components.links":"/static/@ruteni/blaze/v1/css/components.links.css","generics.global":"/static/@ruteni/blaze/v1/css/generics.global.css","objects.containers":"/static/@ruteni/blaze/v1/css/objects.containers.css","objects.forms":"/static/@ruteni/blaze/v1/css/objects.forms.css","objects.images":"/static/@ruteni/blaze/v1/css/objects.images.css","utilities.boxing":"/static/@ruteni/blaze/v1/css/utilities.boxing.css","utilities.sizes":"/static/@ruteni/blaze/v1/css/utilities.sizes.css","utilities.typography":"/static/@ruteni/blaze/v1/css/utilities.typography.css","utilities.visibility":"/static/@ruteni/blaze/v1/css/utilities.visibility.css","variables.host":"/static/@ruteni/blaze/v1/css/variables.host.css"}};const v=e.getLogger("ruteni.plugin.registration.element.form");t(u,import.meta.url);class p extends Error{constructor(e,i){super(`${e[0]} timed out after ${i} milliseconds`),this.args=e,this.timeout=i}}s.addCustomElement(u.tagName);const h=document.createElement("template");h.innerHTML=s.sanitize('<div class="o-container o-container--xsmall u-text"><div data-class="{\'u-display-none\': state !== \'editing\'}"><form name="register"data-on-submit="submit-form"novalidate><a class="c-link"href="/"><img class="o-image u-pillar-box-super"src="/static/@ruteni/site/v1/logo.svg"alt="logo"> </a><input type="hidden"name="appActionToken"value="Dlcy1HjVcD6lj2Fy3vd2Uj2FhzE64ZMj3D"> <input type="hidden"name="appAction"value="REGISTER"> <input type="hidden"name="openid.return_to"value="/somewhere"><h1 class="c-heading u-large"data-l10n-id="create-account"></h1><div class="o-form-element"><label class="c-label"for="displayName"data-l10n-id="your-name"></label> <input class="c-field"minlength="1"maxlength="50"autocomplete="off"id="displayName"name="displayName"required><div class="u-display-none"aria-live="assertive"role="alert"data-l10n-id="enter-your-name"></div><div class="c-hint c-hint--static"role="tooltip"><div data-l10n-id="empty-display-name"data-class="{\'u-display-none\': issues[\'invalid-display-name\'] !== \'empty\'}"></div><div data-l10n-id="overflow-display-name"data-class="{\'u-display-none\': issues[\'invalid-display-name\'] !== \'overflow\'}"></div></div></div><div class="o-form-element"><label class="c-label"for="email"data-l10n-id="email"></label> <input class="c-field"type="email"maxlength="64"id="email"name="email"required><div class="u-display-none"aria-live="assertive"role="alert"data-l10n-id="enter-valid-email"></div><div class="c-hint c-hint--static"role="tooltip"><div data-l10n-id="empty-email"data-class="{\'u-display-none\': issues[\'invalid-email\'] !== \'empty\'}"></div><div data-l10n-id="incomplete-email"data-class="{\'u-display-none\': issues[\'invalid-email\'] !== \'incomplete\'}"></div><div data-l10n-id="misconfigured-domain-email"data-class="{\'u-display-none\': issues[\'invalid-email\'] !== \'misconfigured-domain\'}"></div><div data-l10n-id="overflow-email"data-class="{\'u-display-none\': issues[\'invalid-email\'] !== \'overflow\'}"></div><div data-l10n-id="parse-error-email"data-class="{\'u-display-none\': issues[\'invalid-email\'] !== \'parse-error\'}"></div><div data-l10n-id="unknown-domain-email"data-class="{\'u-display-none\': issues[\'invalid-email\'] !== \'unknown-domain\'}"></div></div></div><div class="o-form-element"><label class="c-label"for="password"data-l10n-id="password"></label> <input class="c-field"type="password"minlength="8"maxlength="1024"autocomplete="off"data-l10n-id="at-least-eight-characters"id="password"name="password"required><div class="u-display-none"aria-live="assertive"role="alert"data-l10n-id="password-eight-characters"></div><div class="c-hint c-hint--static"role="tooltip"><div data-l10n-id="empty-password"data-class="{\'u-display-none\': issues[\'invalid-password\'] !== \'empty\'}"></div><div data-l10n-id="overflow-password"data-class="{\'u-display-none\': issues[\'invalid-password\'] !== \'overflow\'}"></div><div data-l10n-id="weak-password"data-class="{\'u-display-none\': !(\'low-password-strength\' in issues)}"></div></div></div><div class="o-form-element"><label class="c-label"for="passwordCheck"data-l10n-id="reenter-password"></label> <input class="c-field"type="password"minlength="8"maxlength="1024"autocomplete="off"id="passwordCheck"id="passwordCheck"name="passwordCheck"required><div class="u-display-none"aria-live="assertive"role="alert"data-l10n-id="password-must-match"></div><div class="c-hint c-hint--static"role="tooltip"><div data-l10n-id="password-mismatch"data-class="{\'u-display-none\': !issues[\'password-mismatch\']}"></div></div></div><div><div class="c-hint c-hint--static"role="tooltip"><div data-l10n-id="empty-locale"data-class="{\'u-display-none\': issues[\'invalid-locale\'] !== \'empty\'}"></div><div data-l10n-id="unknown-locale"data-class="{\'u-display-none\': issues[\'invalid-locale\'] !== \'unknown\'}"></div><div data-l10n-id="server-timeout"data-class="{\'u-display-none\': !issues[\'server-timeout\']}"></div></div></div><div class="o-form-element"><input class="c-button c-button--block"type="submit"data-l10n-id="create-your-account"></div><div class="u-small"><span data-l10n-id="already-have-an-account"></span> <a href="/ap/signin?openid.return_to=%2Fregistration%2Fap-signin-handler&amp;openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0"data-l10n-id="signin"></a></div></form></div><div data-class="{\'u-display-none\': state !== \'delivered\'}"><h2 class="c-heading u-medium"data-l10n-id="delivered"></h2><p data-l10n-id="check-your-mailbox"data-l10n-deps="minutes"><form name="verify"data-on-submit="verify-code"novalidate><div><label for="displayCode"data-l10n-id="enter-code"></label> <input class="verification-code"minlength="6"maxlength="6"autocomplete="off"id="verificationCode"code="verificationCode"required><div class="u-display-none"aria-live="assertive"role="alert"data-l10n-id="enter-code"></div><div class="c-hint c-hint--static"role="tooltip"><div data-l10n-id="wrong-code-length"data-class="{\'u-display-none\': false}"></div><div data-l10n-id="wrong-code-value"data-l10n-deps="remaining"data-class="{\'u-display-none\': remaining}"></div><div data-l10n-id="server-timeout"data-class="{\'u-display-none\': !issues[\'server-timeout\']}"></div></div></div><input class="c-button c-button--block"type="submit"data-l10n-id="verify-email"></form></div><div data-class="{\'u-display-none\': state !== \'delivery-failed\'}"><h4 class="c-heading u-medium"data-l10n-id="delivery-failed"></h4><button class="c-button c-button--block"data-l10n-id="back-home"data-on-click="back-home"></button></div><div data-class="{\'u-display-none\': state !== \'confirmed\'}"><h4 class="c-heading u-medium"data-l10n-id="email-confirmed"></h4></div><div data-class="{\'u-display-none\': state !== \'code-expired\'}"><h4 class="c-heading u-medium"data-l10n-id="code-expired"></h4><button class="c-button c-button--block"data-l10n-id="back-home"data-on-click="back-home"></button></div><div data-class="{\'u-display-none\': state !== \'too-many-attempts\'}"><h4 class="c-heading u-medium"data-l10n-id="too-many-attempts"></h4><button class="c-button c-button--block"data-l10n-id="back-home"data-on-click="back-home"></button></div></div>');window.customElements.define(u.tagName,class extends n{constructor(){const e={minutes:-1,remaining:-1,issues:{},state:"editing",styles:i.getUrls(u,m),events:{"submit-form":e=>{e.preventDefault(),v.debug("submit-form"),this.submit().catch(v.error)},"verify-code":e=>{e.preventDefault(),this.verify().catch(v.error)},"back-home":e=>this.update({state:"editing"}).catch(v.error)}};super({template:h,state:e,Plugins:[c,l,d,o]}),this._socket=r("/ruteni/registration",{transports:["websocket"]}),this._socket.on("connect",(()=>v.debug("connected"))),this._socket.on("disconnect",(e=>v.debug("disconnected",e))),this._socket.on("connect_error",v.error)}call(e,...i){let t;return Promise.race([new Promise((e=>this._socket.emit(...i,(i=>{clearTimeout(t),e(i)})))),new Promise(((a,s)=>{t=setTimeout((()=>{const t=new p(i,e);s(t)}),e)}))])}async submit(){const e=this.$('form[name="register"]'),{displayName:i,email:t,password:s,passwordCheck:n}=e.elements;try{var l=await this.call(5e3,"edit",{display_name:i.value,email:t.value,password:s.value,locale:a()})}catch(e){return e instanceof p&&await this.update({issues:{"server-timeout":!0}}),void v.error(e)}s.value!==n.value&&(l["password-mismatch"]=!0),Object.keys(l).length?await this.update({issues:l}):await this.register()}async register(){try{var e=await this.call(5e3,"register")}catch(e){return e instanceof p&&await this.update({issues:{"server-timeout":!0}}),void v.error(e)}e?await this.update({state:"delivered",minutes:e}):await this.update({state:"delivery-failed"})}async verify(){const e=this.$('form[name="verify"]'),i=e.elements.verificationCode.value;e.elements.verificationCode.value="";try{var t=await this.call(5e3,"verify",i)}catch(e){return e instanceof p&&await this.update({issues:{"server-timeout":!0}}),void v.error(e)}if(null===t){this._socket.disconnect(),await this.update({state:"confirmed"});const e=new window.CustomEvent("registered",{detail:null});this.dispatchEvent(e)}else-1===t?await this.update({state:"code-expired"}):0===t?await this.update({state:"too-many-attempts"}):t>0?await this.update({remaining:t}):v.error(t)}});
//# sourceMappingURL=index.js.map
