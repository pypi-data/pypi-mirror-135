import e from"/static/@ruteni/logging/v1/index.js";const t=new RegExp("^([a-z]{2,3}|\\*)(?:-([a-z]{4}|\\*))?(?:-([a-z]{2}|\\*))?(?:-(([0-9][a-z0-9]{3}|[a-z0-9]{5,8})|\\*))?$","i");class r{constructor(e){const r=t.exec(e.replace(/_/g,"-"));if(!r)return void(this.isWellFormed=!1);let[,n,i,a,o]=r;n&&(this.language=n.toLowerCase()),i&&(this.script=i[0].toUpperCase()+i.slice(1)),a&&(this.region=a.toUpperCase()),this.variant=o,this.isWellFormed=!0}isEqual(e){return this.language===e.language&&this.script===e.script&&this.region===e.region&&this.variant===e.variant}matches(e,t=!1,r=!1){return(this.language===e.language||t&&void 0===this.language||r&&void 0===e.language)&&(this.script===e.script||t&&void 0===this.script||r&&void 0===e.script)&&(this.region===e.region||t&&void 0===this.region||r&&void 0===e.region)&&(this.variant===e.variant||t&&void 0===this.variant||r&&void 0===e.variant)}toString(){return[this.language,this.script,this.region,this.variant].filter((e=>void 0!==e)).join("-")}clearVariants(){this.variant=void 0}clearRegion(){this.region=void 0}addLikelySubtags(){const e=function(e){if(Object.prototype.hasOwnProperty.call(n,e))return new r(n[e]);const t=new r(e);if(t.language&&i.includes(t.language))return t.region=t.language.toUpperCase(),t;return null}(this.toString().toLowerCase());return!!e&&(this.language=e.language,this.script=e.script,this.region=e.region,this.variant=e.variant,!0)}}const n={ar:"ar-arab-eg","az-arab":"az-arab-ir","az-ir":"az-arab-ir",be:"be-cyrl-by",da:"da-latn-dk",el:"el-grek-gr",en:"en-latn-us",fa:"fa-arab-ir",ja:"ja-jpan-jp",ko:"ko-kore-kr",pt:"pt-latn-br",sr:"sr-cyrl-rs","sr-ru":"sr-latn-ru",sv:"sv-latn-se",ta:"ta-taml-in",uk:"uk-cyrl-ua",zh:"zh-hans-cn","zh-hant":"zh-hant-tw","zh-hk":"zh-hant-hk","zh-mo":"zh-hant-mo","zh-tw":"zh-hant-tw","zh-gb":"zh-hant-gb","zh-us":"zh-hant-us"},i=["az","bg","cs","de","es","fi","fr","hu","it","lt","lv","nl","pl","ro","ru"];function a(e,t,{strategy:n="filtering",defaultLocale:i}={}){const a=function(e,t,n){const i=new Set,a=new Map;for(let e of t)new r(e).isWellFormed&&a.set(e,new r(e));e:for(const t of e){const e=t.toLowerCase(),o=new r(e);if(void 0!==o.language){for(const t of a.keys())if(e===t.toLowerCase()){if(i.add(t),a.delete(t),"lookup"===n)return Array.from(i);if("filtering"===n)continue;continue e}for(const[e,t]of a.entries())if(t.matches(o,!0,!1)){if(i.add(e),a.delete(e),"lookup"===n)return Array.from(i);if("filtering"===n)continue;continue e}if(o.addLikelySubtags())for(const[e,t]of a.entries())if(t.matches(o,!0,!1)){if(i.add(e),a.delete(e),"lookup"===n)return Array.from(i);if("filtering"===n)continue;continue e}o.clearVariants();for(const[e,t]of a.entries())if(t.matches(o,!0,!0)){if(i.add(e),a.delete(e),"lookup"===n)return Array.from(i);if("filtering"===n)continue;continue e}if(o.clearRegion(),o.addLikelySubtags())for(const[e,t]of a.entries())if(t.matches(o,!0,!1)){if(i.add(e),a.delete(e),"lookup"===n)return Array.from(i);if("filtering"===n)continue;continue e}o.clearRegion();for(const[e,t]of a.entries())if(t.matches(o,!0,!0)){if(i.add(e),a.delete(e),"lookup"===n)return Array.from(i);if("filtering"===n)continue;continue e}}}return Array.from(i)}(Array.from(Object(e)).map(String),Array.from(Object(t)).map(String),n);if("lookup"===n){if(void 0===i)throw new Error("defaultLocale cannot be undefined for strategy `lookup`");0===a.length&&a.push(i)}else i&&!a.includes(i)&&a.push(i);return a}class o{constructor(e){this.value=e}valueOf(){return this.value}}class s extends o{constructor(e="???"){super(e)}toString(e){return`{${this.value}}`}}class u extends o{constructor(e,t={}){super(e),this.opts=t}toString(e){try{return e.memoizeIntlObject(Intl.NumberFormat,this.opts).format(this.value)}catch(t){return e.reportError(t),this.value.toString(10)}}}class l extends o{constructor(e,t={}){super(e),this.opts=t}toString(e){try{return e.memoizeIntlObject(Intl.DateTimeFormat,this.opts).format(this.value)}catch(t){return e.reportError(t),new Date(this.value).toISOString()}}}function c(e,t,r){if(r===t)return!0;if(r instanceof u&&t instanceof u&&r.value===t.value)return!0;if(t instanceof u&&"string"==typeof r){if(r===e.memoizeIntlObject(Intl.PluralRules,t.opts).select(t.value))return!0}return!1}function f(e,t,r){return t[r]?p(e,t[r].value):(e.reportError(new RangeError("No default")),new s)}function g(e,t){const r=[],n=Object.create(null);for(const i of t)"narg"===i.type?n[i.name]=h(e,i.value):r.push(h(e,i));return{positional:r,named:n}}function h(e,t){switch(t.type){case"str":return t.value;case"num":return new u(t.value,{minimumFractionDigits:t.precision});case"var":return function(e,{name:t}){let r;if(e.params){if(!Object.prototype.hasOwnProperty.call(e.params,t))return new s(`$${t}`);r=e.params[t]}else{if(!e.args||!Object.prototype.hasOwnProperty.call(e.args,t))return e.reportError(new ReferenceError(`Unknown variable: $${t}`)),new s(`$${t}`);r=e.args[t]}if(r instanceof o)return r;switch(typeof r){case"string":return r;case"number":return new u(r);case"object":if(r instanceof Date)return new l(r.getTime());default:return e.reportError(new TypeError(`Variable type not supported: $${t}, ${typeof r}`)),new s(`$${t}`)}}(e,t);case"mesg":return function(e,{name:t,attr:r}){const n=e.bundle._messages.get(t);if(!n)return e.reportError(new ReferenceError(`Unknown message: ${t}`)),new s(t);if(r){const i=n.attributes[r];return i?p(e,i):(e.reportError(new ReferenceError(`Unknown attribute: ${r}`)),new s(`${t}.${r}`))}if(n.value)return p(e,n.value);return e.reportError(new ReferenceError(`No value: ${t}`)),new s(t)}(e,t);case"term":return function(e,{name:t,attr:r,args:n}){const i=`-${t}`,a=e.bundle._terms.get(i);if(!a)return e.reportError(new ReferenceError(`Unknown term: ${i}`)),new s(i);if(r){const t=a.attributes[r];if(t){e.params=g(e,n).named;const r=p(e,t);return e.params=null,r}return e.reportError(new ReferenceError(`Unknown attribute: ${r}`)),new s(`${i}.${r}`)}e.params=g(e,n).named;const o=p(e,a.value);return e.params=null,o}(e,t);case"func":return function(e,{name:t,args:r}){let n=e.bundle._functions[t];if(!n)return e.reportError(new ReferenceError(`Unknown function: ${t}()`)),new s(`${t}()`);if("function"!=typeof n)return e.reportError(new TypeError(`Function ${t}() is not callable`)),new s(`${t}()`);try{let t=g(e,r);return n(t.positional,t.named)}catch(r){return e.reportError(r),new s(`${t}()`)}}(e,t);case"select":return function(e,{selector:t,variants:r,star:n}){let i=h(e,t);if(i instanceof s)return f(e,r,n);for(const t of r){if(c(e,i,h(e,t.key)))return p(e,t.value)}return f(e,r,n)}(e,t);default:return new s}}function d(e,t){if(e.dirty.has(t))return e.reportError(new RangeError("Cyclic reference")),new s;e.dirty.add(t);const r=[],n=e.bundle._useIsolating&&t.length>1;for(const i of t)if("string"!=typeof i){if(e.placeables++,e.placeables>100)throw e.dirty.delete(t),new RangeError(`Too many placeables expanded: ${e.placeables}, max allowed is 100`);n&&r.push("⁨"),r.push(h(e,i).toString(e)),n&&r.push("⁩")}else r.push(e.bundle._transform(i));return e.dirty.delete(t),r.join("")}function p(e,t){return"string"==typeof t?e.bundle._transform(t):d(e,t)}class m{constructor(e,t,r){this.dirty=new WeakSet,this.params=null,this.placeables=0,this.bundle=e,this.errors=t,this.args=r}reportError(e){if(!(this.errors&&e instanceof Error))throw e;this.errors.push(e)}memoizeIntlObject(e,t){let r=this.bundle._intls.get(e);r||(r={},this.bundle._intls.set(e,r));let n=JSON.stringify(t);return r[n]||(r[n]=new e(this.bundle.locales,t)),r[n]}}function w(e,t){const r=Object.create(null);for(const[n,i]of Object.entries(e))t.includes(n)&&(r[n]=i.valueOf());return r}const y=["unitDisplay","currencyDisplay","useGrouping","minimumIntegerDigits","minimumFractionDigits","maximumFractionDigits","minimumSignificantDigits","maximumSignificantDigits"];function v(e,t){let r=e[0];if(r instanceof s)return new s(`NUMBER(${r.valueOf()})`);if(r instanceof u)return new u(r.valueOf(),{...r.opts,...w(t,y)});if(r instanceof l)return new u(r.valueOf(),{...w(t,y)});throw new TypeError("Invalid argument to NUMBER")}const b=["dateStyle","timeStyle","fractionalSecondDigits","dayPeriod","hour12","weekday","era","year","month","day","hour","minute","second","timeZoneName"];function E(e,t){let r=e[0];if(r instanceof s)return new s(`DATETIME(${r.valueOf()})`);if(r instanceof l)return new l(r.valueOf(),{...r.opts,...w(t,b)});if(r instanceof u)return new l(r.valueOf(),{...w(t,b)});throw new TypeError("Invalid argument to DATETIME")}const $=new Map;class x{constructor(e,{functions:t,useIsolating:r=!0,transform:n=(e=>e)}={}){this._terms=new Map,this._messages=new Map,this.locales=Array.isArray(e)?e:[e],this._functions={NUMBER:v,DATETIME:E,...t},this._useIsolating=r,this._transform=n,this._intls=function(e){const t=Array.isArray(e)?e.join(" "):e;let r=$.get(t);return void 0===r&&(r=new Map,$.set(t,r)),r}(e)}hasMessage(e){return this._messages.has(e)}getMessage(e){return this._messages.get(e)}addResource(e,{allowOverrides:t=!1}={}){const r=[];for(let n=0;n<e.body.length;n++){let i=e.body[n];if(i.id.startsWith("-")){if(!1===t&&this._terms.has(i.id)){r.push(new Error(`Attempt to override an existing term: "${i.id}"`));continue}this._terms.set(i.id,i)}else{if(!1===t&&this._messages.has(i.id)){r.push(new Error(`Attempt to override an existing message: "${i.id}"`));continue}this._messages.set(i.id,i)}}return r}formatPattern(e,t=null,r=null){if("string"==typeof e)return this._transform(e);let n=new m(this,r,t);try{return d(n,e).toString(n)}catch(e){if(n.errors&&e instanceof Error)return n.errors.push(e),(new s).toString(n);throw e}}}const S=/^(-?[a-zA-Z][\w-]*) *= */gm,k=/\.([a-zA-Z][\w-]*) *= */y,z=/\*?\[/y,I=/(-?[0-9]+(?:\.([0-9]+))?)/y,O=/([a-zA-Z][\w-]*)/y,A=/([$-])?([a-zA-Z][\w-]*)(?:\.([a-zA-Z][\w-]*))?/y,j=/^[A-Z][A-Z0-9_-]*$/,_=/([^{}\n\r]+)/y,R=/([^\\"\n\r]*)/y,U=/\\([\\"])/y,D=/\\u([a-fA-F0-9]{4})|\\U([a-fA-F0-9]{6})/y,L=/^\n+/,M=/ +$/,F=/ *\r?\n/g,T=/( *)$/,C=/{\s*/y,N=/\s*}/y,Z=/\[\s*/y,P=/\s*] */y,B=/\s*\(\s*/y,W=/\s*->\s*/y,V=/\s*:\s*/y,q=/\s*,?\s*/y,G=/\s+/y;class J{constructor(e){this.body=[],S.lastIndex=0;let t=0;for(;;){let r=S.exec(e);if(null===r)break;t=S.lastIndex;try{this.body.push(s(r[1]))}catch(e){if(e instanceof SyntaxError)continue;throw e}}function r(r){return r.lastIndex=t,r.test(e)}function n(r,n){if(e[t]===r)return t++,!0;if(n)throw new n(`Expected ${r}`);return!1}function i(e,n){if(r(e))return t=e.lastIndex,!0;if(n)throw new n(`Expected ${e.toString()}`);return!1}function a(r){r.lastIndex=t;let n=r.exec(e);if(null===n)throw new SyntaxError(`Expected ${r.toString()}`);return t=r.lastIndex,n}function o(e){return a(e)[1]}function s(e){let t=u(),n=function(){let e=Object.create(null);for(;r(k);){let t=o(k),r=u();if(null===r)throw new SyntaxError("Expected attribute value");e[t]=r}return e}();if(null===t&&0===Object.keys(n).length)throw new SyntaxError("Expected message value or attributes");return{id:e,value:t,attributes:n}}function u(){let n;if(r(_)&&(n=o(_)),"{"===e[t]||"}"===e[t])return l(n?[n]:[],1/0);let i=w();return i?n?l([n,i],i.length):(i.value=y(i.value,L),l([i],i.length)):n?y(n,M):null}function l(n=[],i){for(;;){if(r(_)){n.push(o(_));continue}if("{"===e[t]){n.push(c());continue}if("}"===e[t])throw new SyntaxError("Unbalanced closing brace");let a=w();if(!a)break;n.push(a),i=Math.min(i,a.length)}let a=n.length-1,s=n[a];"string"==typeof s&&(n[a]=y(s,M));let u=[];for(let e of n)e instanceof H&&(e=e.value.slice(0,e.value.length-i)),e&&u.push(e);return u}function c(){i(C,SyntaxError);let e=f();if(i(N))return e;if(i(W)){let t=function(){let e,t=[],i=0;for(;r(z);){n("*")&&(e=i);let r=h(),a=u();if(null===a)throw new SyntaxError("Expected variant value");t[i++]={key:r,value:a}}if(0===i)return null;if(void 0===e)throw new SyntaxError("Expected default variant");return{variants:t,star:e}}();return i(N,SyntaxError),{type:"select",selector:e,...t}}throw new SyntaxError("Unclosed placeable")}function f(){if("{"===e[t])return c();if(r(A)){let[,r,n,o=null]=a(A);if("$"===r)return{type:"var",name:n};if(i(B)){let a=function(){let r=[];for(;;){switch(e[t]){case")":return t++,r;case void 0:throw new SyntaxError("Unclosed argument list")}r.push(g()),i(q)}}();if("-"===r)return{type:"term",name:n,attr:o,args:a};if(j.test(n))return{type:"func",name:n,args:a};throw new SyntaxError("Function names must be all upper-case")}return"-"===r?{type:"term",name:n,attr:o,args:[]}:{type:"mesg",name:n,attr:o}}return d()}function g(){let e=f();return"mesg"!==e.type?e:i(V)?{type:"narg",name:e.name,value:d()}:e}function h(){let e;return i(Z,SyntaxError),e=r(I)?p():{type:"str",value:o(O)},i(P,SyntaxError),e}function d(){if(r(I))return p();if('"'===e[t])return function(){n('"',SyntaxError);let r="";for(;;){if(r+=o(R),"\\"!==e[t]){if(n('"'))return{type:"str",value:r};throw new SyntaxError("Unclosed string literal")}r+=m()}}();throw new SyntaxError("Invalid expression")}function p(){let[,e,t=""]=a(I),r=t.length;return{type:"num",value:parseFloat(e),precision:r}}function m(){if(r(U))return o(U);if(r(D)){let[,e,t]=a(D),r=parseInt(e||t,16);return r<=55295||57344<=r?String.fromCodePoint(r):"�"}throw new SyntaxError("Unknown escape sequence")}function w(){let r=t;switch(i(G),e[t]){case".":case"[":case"*":case"}":case void 0:return!1;case"{":return v(e.slice(r,t))}return" "===e[t-1]&&v(e.slice(r,t))}function y(e,t){return e.replace(t,"")}function v(e){let t=e.replace(F,"\n"),r=T.exec(e)[1].length;return new H(t,r)}}}class H{constructor(e,t){this.value=e,this.length=t}}const K=e.getLogger("ruteni.plugin.translation"),Q=()=>document.documentElement.lang=navigator.language;function X(){return navigator.language}window.addEventListener("languagechange",Q),Q();const Y={};class ee{constructor(e,t,r){this.resourceId=e,this.resolve=r,this.bundles={},this.supportedLocales=a(navigator.languages,t,{defaultLocale:"en-US"})}async getBundle(e){K.debug(`resolving bundle for ${this.resourceId}`);let t=this.bundles[e];if(!t){const r=this.resolve(e);K.debug(`${this.resourceId} bundle for ${e} at ${r}`);const n=await fetch(r);if(!n.ok)throw new Error(`could not fetch bundle at ${r}`);const i=await n.text(),a=new J(i);t=new x(e);const o=t.addResource(a);o.length&&K.warn(`errors were found in ${this.resourceId} bundle for ${e}: ${o}`),this.bundles[e]=t}return t}}function te(e,t,r){Y[e]=new ee(e,t,r),K.debug(`registered bundle resolver for ${e}`)}function re(e,t){const r=t.slice(0,t.lastIndexOf("/"));te(e.tagName,e.languages,(e=>`${r}/locales/${e}.ftl`))}function ne(e){return Y[e]}var ie={getBundleResolver:ne,getLanguage:X,registerBundleResolver:te};export{x as FluentBundle,J as FluentResource,ie as default,ne as getBundleResolver,X as getLanguage,a as negotiateLanguages,te as registerBundleResolver,re as registerElementBundleResolver};
