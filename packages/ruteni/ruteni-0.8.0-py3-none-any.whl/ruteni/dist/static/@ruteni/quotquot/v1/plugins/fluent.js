import e from"/static/@ruteni/translation/v1/index.js";import t from"/static/@ruteni/logging/v1/index.js";import s from"/static/@ruteni/security/v1/index.js";const n=t.getLogger("@quotquot/fluent"),a=/<|&#?\w+;/,r=document.documentElement.namespaceURI;class i{constructor(e){this.el=e,this.nodes=[]}async render(e,t,i,o){if(o&&-1===o.indexOf("language")){const e=this.el.dataset.l10nDeps;if(!e)return;const t=new Set(e.split());if(!o.some((e=>t.has(e))))return;n.debug(`deps changed for ${this.el.dataset.l10nId}:`,t)}this.clear(),this.nodes=function(e,t,n,i){const o=t.dataset.l10nId.trim(),d=Object.assign({},i,JSON.parse(t.dataset.l10nArgs||"{}")),l=e.getMessage(o),u=[];if(l.value){const n=e.formatPattern(l.value,d);if(!a.test(l.value)||"title"===t.localName&&t.namespaceURI===r){for(;t.firstChild;)t.firstChild.remove();const e=document.createTextNode(n);t.appendChild(e),u.push(e)}else t.innerHTML=s.sanitize(n),u.push(...t.children)}for(let[s,n]of Object.entries(l.attributes)){const a=document.createAttribute(s);a.value=e.formatPattern(n,d),t.setAttributeNode(a),u.push(a)}return u}(e,this.el,i.language,i)}clear(){for(const e of this.nodes)e.nodeType===Node.ATTRIBUTE_NODE?e.ownerElement.removeAttributeNode(e):e.remove();this.nodes.length=0}}class o{constructor(t){if(this.handlers=new Map,this.resourceId=t.tagName.toLowerCase(),this.resolver=e.getBundleResolver(this.resourceId),!this.resolver)throw new Error(`no bundle resolver for ${this.resourceId}`);this.update=()=>this.resolve().then((e=>t.update({language:e}))).catch((e=>t.onerror(e,"plugin","fluent","update"))),t.renderers.push(this)}async resolve(){const e=navigator.language;if(this.bundle=await this.resolver.getBundle(e),!this.bundle)throw new Error(`missing ${this.resourceId} bundle for ${e}`);return e}async _addHandler(e,t,s){const n=new i(e);this.handlers.set(e,n),await n.render(this.bundle,t,s)}async _processMutations(e,t){const s=[],a=[];for(const e of t||this.observer.takeRecords())("data-l10n-id"===e.attributeName?s:a).push(e);const r=new Set;for(const t of s){const s=t.target,a=s.getAttributeNode("data-l10n-id"),i=this.handlers.get(s);null===t.oldValue?(a||n.warn("unexpected: element should have a data-l10n-id"),i&&n.warn("unexpected: handler should not exist"),await this._addHandler(s,e,e.state),r.add(s)):a?t.oldValue!==a.value&&(await i.render(this.bundle,e,e.state),r.add(s)):(i.clear(),this.handlers.delete(s))}for(const t of a){const s=t.target,a=t.attributeName;if(!this.handlers.has(s)){s.hasAttribute("data-l10n-id")&&n.warn("unexpected: no handler for fluent element"),n.warn(`unused ${a} attribute`);continue}if(r.has(s))continue;const i=this.handlers.get(s);await i.render(this.bundle,e,e.state),r.add(s)}}async setup(e){e.state.language=navigator.language,window.addEventListener("languagechange",this.update),this.observer=new MutationObserver((t=>this._processMutations(e,t).catch((t=>e.onerror(t,"plugin","fluent","mutation"))))),this.observer.observe(e.shadowRoot,{subtree:!0,attributeFilter:["data-l10n-id","data-l10n-args"],attributeOldValue:!0}),await this.resolve()}async cleanup(e){this.observer&&(this.observer.disconnect(),this.observer=null);for(const e of this.handlers.values())e.clear();this.handlers.clear(),window.removeEventListener("languagechange",this.update)}async renderElement(e,t,s,n,a,r){if(!s.language||!e.hasAttribute("data-l10n-id"))return;const i=this.handlers.get(e);i?await i.render(this.bundle,t,s,n):await this._addHandler(e,t,s,n)}}export{o as default};
