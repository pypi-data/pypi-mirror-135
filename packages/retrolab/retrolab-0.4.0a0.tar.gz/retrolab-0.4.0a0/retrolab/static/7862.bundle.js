(self.webpackChunk_JUPYTERLAB_CORE_OUTPUT=self.webpackChunk_JUPYTERLAB_CORE_OUTPUT||[]).push([[7862],{87862:(e,s,t)=>{"use strict";t.r(s),t.d(s,{IDocumentProviderFactory:()=>i,ProviderMock:()=>n,WebSocketProviderWithLocks:()=>S});class n{requestInitialContent(){return Promise.resolve(!1)}putInitializedState(){}acquireLock(){return Promise.resolve(0)}releaseLock(e){}destroy(){}setPath(e){}}var c=t(55147);const i=new c.Token("@jupyterlab/docprovider:IDocumentProviderFactory");var o=t(66962),a=t(74833),r=t(64978),h=t(22592),l=t(47941),d=t(83149);const u=new Map,w="undefined"==typeof BroadcastChannel?class{constructor(e){this.room=e,this.onmessage=null,d.z((s=>s.key===e&&null!==this.onmessage&&this.onmessage({data:l.Gh(s.newValue||"")})))}postMessage(e){d.X.setItem(this.room,l.s3(l.eh(e)))}}:BroadcastChannel,_=e=>h.Yu(u,e,(()=>{const s=new Set,t=new w(e);return t.onmessage=e=>s.forEach((s=>s(e.data))),{bc:t,subs:s}})),y=(e,s)=>{const t=_(e);t.bc.postMessage(s),t.subs.forEach((e=>e(s)))};var f=t(2431);const m=(e,s)=>{a.uE(e,0);const t=r.encodeStateVector(s);a.mP(e,t)},p=(e,s,t)=>{a.uE(e,1),a.mP(e,r.encodeStateAsUpdate(s,t))},b=(e,s,t)=>{try{r.applyUpdate(s,o.HN(e),t)}catch(e){console.error("Caught error while handling a Yjs update",e)}},g=b;var v=t(90157),I=t(94236),k=t(95641),C=t(11182),M=t(36498);const U=[];U[0]=(e,s,t,n,c)=>{a.uE(e,0);const i=((e,s,t,n)=>{const c=o.yg(e);switch(c){case 0:((e,s,t)=>{p(s,t,o.HN(e))})(e,s,t);break;case 1:b(e,t,n);break;case 2:g(e,t,n);break;default:throw new Error("Unknown message type")}return c})(s,e,t.doc,t);n&&1===i&&!t.synced&&(t.synced=!0)},U[3]=(e,s,t,n,c)=>{a.uE(e,1),a.mP(e,v.xq(t.awareness,Array.from(t.awareness.getStates().keys())))},U[1]=(e,s,t,n,c)=>{v.oy(t.awareness,o.HN(s),t)},U[2]=(e,s,t,n,c)=>{((e,s,t)=>{switch(o.yg(e)){case 0:t(s,o.kf(e))}})(s,t.doc,L)};const L=(e,s)=>console.warn(`Permission denied to access ${e.url}.\n${s}`),q=(e,s,t)=>{const n=o.l1(s),c=a.Mf(),i=o.yg(n),r=e.messageHandlers[i];return r?r(c,n,e,t,i):console.error("Unable to compute message"),c},R=e=>{if(e.shouldConnect&&null===e.ws){const s=new e._WS(e.url);s.binaryType="arraybuffer",e.ws=s,e.wsconnecting=!0,e.wsconnected=!1,e.synced=!1,s.onmessage=t=>{e.wsLastMessageReceived=f.ZG();const n=q(e,new Uint8Array(t.data),!0);a.kE(n)>1&&s.send(a._f(n))},s.onclose=()=>{e.ws=null,e.wsconnecting=!1,e.wsconnected?(e.wsconnected=!1,e.synced=!1,v.Ag(e.awareness,Array.from(e.awareness.getStates().keys()).filter((s=>s!==e.doc.clientID)),e),e.emit("status",[{status:"disconnected"}])):e.wsUnsuccessfulReconnects++,setTimeout(R,C.VV(1200*C.mv(e.wsUnsuccessfulReconnects+1),2500),e)},s.onopen=()=>{e.wsLastMessageReceived=f.ZG(),e.wsconnecting=!1,e.wsconnected=!0,e.wsUnsuccessfulReconnects=0,e.emit("status",[{status:"connected"}]);const t=a.Mf();if(a.uE(t,0),m(t,e.doc),s.send(a._f(t)),null!==e.awareness.getLocalState()){const t=a.Mf();a.uE(t,1),a.mP(t,v.xq(e.awareness,[e.doc.clientID])),s.send(a._f(t))}},e.emit("status",[{status:"connecting"}])}},E=(e,s)=>{e.wsconnected&&e.ws.send(s),e.bcconnected&&e.mux((()=>{y(e.bcChannel,s)}))};class P extends k.y{constructor(e,s,t,{connect:n=!0,awareness:c=new v.GL(t),params:i={},WebSocketPolyfill:o=WebSocket,resyncInterval:r=-1}={}){for(super();"/"===e[e.length-1];)e=e.slice(0,e.length-1);const h=(e=>M.UI(e,((e,s)=>`${encodeURIComponent(s)}=${encodeURIComponent(e)}`)).join("&"))(i);this.bcChannel=e+"/"+s,this.url=e+"/"+s+(0===h.length?"":"?"+h),this.roomname=s,this.doc=t,this._WS=o,this.awareness=c,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.wsUnsuccessfulReconnects=0,this.messageHandlers=U.slice(),this.mux=I.M(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=n,this._resyncInterval=0,r>0&&(this._resyncInterval=setInterval((()=>{if(this.ws){const e=a.Mf();a.uE(e,0),m(e,t),this.ws.send(a._f(e))}}),r)),this._bcSubscriber=e=>{this.mux((()=>{const s=q(this,new Uint8Array(e),!1);a.kE(s)>1&&y(this.bcChannel,a._f(s))}))},this._updateHandler=(e,s)=>{if(s!==this){const s=a.Mf();a.uE(s,0),((e,s)=>{a.uE(e,2),a.mP(e,s)})(s,e),E(this,a._f(s))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:e,updated:s,removed:t},n)=>{const i=e.concat(s).concat(t),o=a.Mf();a.uE(o,1),a.mP(o,v.xq(c,i)),E(this,a._f(o))},"undefined"!=typeof window&&window.addEventListener("beforeunload",(()=>{v.Ag(this.awareness,[t.clientID],"window unload")})),c.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval((()=>{this.wsconnected&&3e4<f.ZG()-this.wsLastMessageReceived&&this.ws.close()}),3e3),n&&this.connect()}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e,this.emit("synced",[e]),this.emit("sync",[e]))}destroy(){0!==this._resyncInterval&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){var e,s;this.bcconnected||(e=this.bcChannel,s=this._bcSubscriber,_(e).subs.add(s),this.bcconnected=!0),this.mux((()=>{const e=a.Mf();a.uE(e,0),m(e,this.doc),y(this.bcChannel,a._f(e));const s=a.Mf();a.uE(s,0),p(s,this.doc),y(this.bcChannel,a._f(s));const t=a.Mf();a.uE(t,3),y(this.bcChannel,a._f(t));const n=a.Mf();a.uE(n,1),a.mP(n,v.xq(this.awareness,[this.doc.clientID])),y(this.bcChannel,a._f(n))}))}disconnectBc(){const e=a.Mf();var s,t;a.uE(e,1),a.mP(e,v.xq(this.awareness,[this.doc.clientID],new Map)),E(this,a._f(e)),this.bcconnected&&(s=this.bcChannel,t=this._bcSubscriber,_(s).subs.delete(t),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),null!==this.ws&&this.ws.close()}connect(){this.shouldConnect=!0,this.wsconnected||null!==this.ws||(R(this),this.connectBc())}}class S extends P{constructor(e){super(e.url,e.contentType+":"+e.path,e.ymodel.ydoc,{awareness:e.ymodel.awareness}),this._currentLockRequest=null,this._initialContentRequest=null,this._path=e.path,this._contentType=e.contentType,this._serverUrl=e.url,this.messageHandlers[127]=(e,s,t,n,c)=>{const i=o.Jl(s),a=this._currentLockRequest;this._currentLockRequest=null,a&&a.resolve(i)},this.messageHandlers[125]=(e,s,t,n,c)=>{const i=o.iU(s);i.byteLength>0&&setTimeout((()=>{r.applyUpdate(this.doc,i)}),0);const a=this._initialContentRequest;this._initialContentRequest=null,a&&a.resolve(i.byteLength>0)},this._isInitialized=!1,this._onConnectionStatus=this._onConnectionStatus.bind(this),this.on("status",this._onConnectionStatus);const s=e.ymodel.awareness,t=e.user,n=()=>{const e=""!==t.displayName?t.displayName:t.name;s.setLocalStateField("user",Object.assign(Object.assign({},t.toJSON()),{name:e}))};t.isReady&&n(),t.ready.connect(n),t.changed.connect(n)}setPath(e){if(e!==this._path){this._path=e;const s=a.Mf();a.cW(s,123);const t=unescape(encodeURIComponent(this._contentType+":"+e));for(let e=0;e<t.length;e++)a.cW(s,t.codePointAt(e));this._sendMessage(a._f(s)),this.disconnectBc(),this.bcChannel=this._serverUrl+"/"+this._contentType+":"+this._path,this.url=this.bcChannel,this.connectBc()}}requestInitialContent(){return this._initialContentRequest||(this._initialContentRequest=new c.PromiseDelegate,this._sendMessage(new Uint8Array([125])),setTimeout((()=>{var e;return null===(e=this._initialContentRequest)||void 0===e?void 0:e.resolve(!1)}),1e3)),this._initialContentRequest.promise}putInitializedState(){const e=a.Mf();a.uE(e,124),a.HK(e,r.encodeStateAsUpdate(this.doc)),this._sendMessage(a._f(e)),this._isInitialized=!0}acquireLock(){if(this._currentLockRequest)return this._currentLockRequest.promise;let e,s;this._sendMessage(new Uint8Array([127])),this._requestLockInterval&&clearInterval(this._requestLockInterval),this._requestLockInterval=setInterval((()=>{this.wsconnected&&this._sendMessage(new Uint8Array([127]))}),500);const t=new Promise(((t,n)=>{e=t,s=n}));return this._currentLockRequest={promise:t,resolve:e,reject:s},t}releaseLock(e){const s=a.Mf();a.uE(s,126),a.Ep(s,e),this._sendMessage(a._f(s)),this._requestLockInterval&&clearInterval(this._requestLockInterval)}_sendMessage(e){const s=()=>{setTimeout((()=>{this.wsconnected?this.ws.send(e):this.once("status",s)}),0)};s()}async _onConnectionStatus(e){if(this._isInitialized&&"connected"===e.status){const e=await this.acquireLock();await this.requestInitialContent()||this.putInitializedState(),this.releaseLock(e)}}}},94236:(e,s,t)=>{"use strict";t.d(s,{M:()=>n});const n=()=>{let e=!0;return(s,t)=>{if(e){e=!1;try{s()}finally{e=!0}}else void 0!==t&&t()}}}}]);