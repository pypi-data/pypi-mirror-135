import{_ as _e,A as je,E as Be}from"./index.70d1c732.js";import{e as me,f as g,s as E,i as Ge,ax as he,j as ee,B as Ee,av as Ve,r as fe,o as V,c as te,d as j,F as ye,m as Oe,q as xe,u as I,n as We,a8 as we,G as De,l as Ke,A as He,a as O,p as Pe,b as Ue,$ as B,ay as ce,aw as Ye,au as Je,M as Qe}from"./vendor.c935fcc5.js";import{R as Xe,M as Ze,p as P,c as et,s as tt,a as at,b as ke}from"./MiniRadar.5d853eff.js";const st=T=>(Pe("data-v-9e01452a"),T=T(),Ue(),T),rt=st(()=>j("svg",{class:"radar__canvas"},[j("g",{class:"radar__edge-container"}),j("g",{class:"radar__ring-container"})],-1)),nt={class:"radar__node-container"},ot={class:"radar__minimap-controls-container"},it={class:"mb-1 d-flex align-center justify-end"},ct={class:"radar__minimap-container"},lt=me({props:{items:{type:Array,required:!0},id:{type:String,required:!0}},setup(T){const w=T,k=g(w.items),h=g(),L=g(),W=g(),F=g(),ae=g(),U=E(()=>{const t=[...N.value.entries()];return new Map([...u.value.nodes.entries()].filter(([,s])=>t.every(([,i])=>!i.get(s.id))).filter(([,s])=>{var a;if(!u.value.rings.get(s.ring))return;const r=s.position;if(!r)return;const n=[...r.nodes.values()];return((a=n==null?void 0:n[0])==null?void 0:a.id)==s.id}))}),$e=E(()=>{const t=new Set([...U.value.entries()].map(([,s])=>s.ring));return new Map([...u.value.rings.entries()].filter(([s])=>t.has(s)))}),se=E(()=>{const t=[...N.value.entries()];return u.value.links.filter(s=>t.every(([,i])=>!i.get(s.target.id))).filter(s=>U.value.get(s.source.id)&&U.value.get(s.target.id))}),be=({transform:t})=>{var i,r,n;const s=`translate(${t.x}px, ${t.y}px) scale(${t.k})`;(i=F.value)==null||i.style("transform",s),(r=W.value)==null||r.style("transform",s),(n=ae.value)==null||n.style("transform",s),de.value=t},Re=t=>{u.value.expandRing(t.ring)},ze=t=>{if(N.value.get(t.id))N.value.delete(t.id);else{const s=u.value.traverse(t);N.value.set(t.id,s)}},Ae=()=>{var i;const t=(r,n,a,v)=>{const _=v*(P/180),e=r+a*et(_)||0,l=n+a*tt(_)||0;return[e,l]},s=([,r],n=1)=>{const a=r.radius,_=125*360/(2*P*a),e=b.value/2*n,l=$.value/2*n,[o,m]=t(e,l,a,90-_),[R,D]=t(e,l,a,90+_);return`M ${o} ${m} A${r.radius} ${r.radius} 0 1 0 ${R} ${D}`};(i=F.value)==null||i.selectAll(".radar__ring").data($e.value).join(r=>{const n=r.append("g");return n.attr("id",v=>v.id),n.attr("class","radar__ring").append("path").attr("id",([v])=>v).attr("d",v=>s(v,1)).style("opacity",1).attr("fill","transparent").attr("stroke","rgba(0, 0, 0, 0.03)").attr("stroke-width",80),n},r=>(r.select("path").attr("id",([a])=>a).attr("d",a=>s(a,1)),r),r=>r.remove())},Y=()=>{var _;const t=(e,l,o,m,R)=>{const D=at(ke(o-e,2)+ke(m-l,2)),c=R/D,z=(1-c)*e+c*o,A=(1-c)*l+c*m;return[z,A]},s=(e,l)=>{const o=Je(),m=P/2,R=3*P/2,D=0,c=u.value.rings.get(e.source.ring),z=u.value.rings.get(e.target.ring),A=u.value.rings.get(e.target.ring-1),ve=u.value.rings.get(e.source.ring+1),ge=c.links,Ne=ge.findIndex(p=>p.source.id==e.source.id&&p.target.id==e.target.id),y=b.value/2,C=$.value/2,ie=(z.radius-c.radius)/2,Se=ie/ge.length,pe=Ne*Se,J=e.target.cx,Q=e.target.cy,q=e.target.radian,X=e.source.cx,Z=e.source.cy,M=e.source.radian;let K,H;if(c.radius==0){const[p,x]=t(y,C,J,Q,z.radius-c.radius);K=p,H=x}else if(e.target.ring-e.source.ring==1){const[p,x]=t(y,C,X,Z,c.radius+ie*1.25-pe);K=p,H=x}else{const[p,x]=t(y,C,X,Z,c.radius+(ve.radius-c.radius)/2);K=p,H=x}if(o.moveTo(X,Z),e.target.ring-e.source.ring>1){c.radius!==0&&(o.lineTo(K,H),o.arc(y,C,c.radius+(ve.radius-c.radius)/2,M,m,M<R&&M>D));const p=A.radius+(z.radius-A.radius)/2,[x,G]=t(y,C,y,p,A.radius+(z.radius-A.radius)/2);o.lineTo(x,G),o.arc(y,C,A.radius+(z.radius-A.radius)/2,m,q,q>R||q<m)}else{o.lineTo(K,H);const[p,x]=t(y,C,J,Q,z.radius-c.radius);if(J!==X&&Q!==Z&&c.radius!==0){const G=P/2;o.arc(y,C,c.radius+ie*1.25-pe,M,q,M>G&&q>G&&q<M||M<G&&(q>G||q<M))}else o.moveTo(p,x)}return o.lineTo(J,Q),o.toString()},i=e=>{const l=u.value.rings.get(e.source.ring),o=u.value.rings.get(e.target.ring),m=l.links,R=(o.radius-l.radius)/m.length;return Math.min(5,R)},r=e=>{const l=d.includes(e.source.id)||d.includes(e.target.id),o=f.value&&(e.source.id==f.value||e.target.id==f.value);return l||o},n=e=>!f.value&&d.length===0||r(e)?1:.2,a=e=>e.source.id+"---"+e.target.id,v=e=>{const l=["radar__edge"];return(r(e)||d.length==0&&!f.value)&&l.push(`${e.source.data.state.type.toLowerCase()}-stroke`),se.value.length<100&&l.push("radar__edge--transition"),l.join(" ")};(_=W.value)==null||_.selectAll(".radar__edge").data(se.value).join(e=>e.append("path").attr("id",a).attr("class",v).style("stroke-width",i).attr("d",s).style("opacity",n),e=>e.attr("id",a).attr("class",v).style("stroke-width",i).attr("d",s).style("opacity",n),e=>e.remove())},re=()=>{Ae(),Y()},le=t=>{f.value==t?f.value=void 0:f.value=t,requestAnimationFrame(()=>Y())},ue=t=>{const s=d.indexOf(t);s>-1?d.splice(s,1):d.push(t)},Ce=t=>{requestAnimationFrame(()=>{B(".radar__canvas").transition().duration(200).call(S.value.transform,t)})},qe=({x:t,y:s})=>{S.value.translateBy(B(".radar__canvas"),t,s)},Me=()=>{d.length=0},ne=()=>{B(".radar__canvas").transition().ease(ce).duration(250).call(S.value.transform,Ye)},Ie=()=>{requestAnimationFrame(()=>{S.value.scaleBy(B(".radar__canvas").transition().ease(ce).duration(250),1.35)})},Te=()=>{requestAnimationFrame(()=>{S.value.scaleBy(B(".radar__canvas").transition().ease(ce).duration(250),.65)})},$=g(0),b=g(0),f=g(),d=Ge([]),de=g({x:0,y:0,k:1}),N=g(new Map),u=g(new Xe),S=g(he());ee(()=>[w.items,w.id],(t,s)=>{const[i,r]=t,[n,a]=s;k.value=w.items,u.value.items(k.value),(i.length>0&&n.length==0||r!==a)&&(u.value.center([b.value/2,$.value/2]),d.length=0,ne()),i.length!==n.length||r!==a?requestAnimationFrame(()=>re()):requestAnimationFrame(()=>Y())}),ee(d,()=>{requestAnimationFrame(()=>Y())}),ee(se,()=>{requestAnimationFrame(()=>re())});const oe=()=>{!h.value||($.value=h.value.offsetHeight,b.value=h.value.offsetWidth)},Le=()=>{var t;L.value=B(".radar__canvas"),F.value=L.value.select(".radar__ring-container"),W.value=L.value.select(".radar__edge-container"),ae.value=B(".radar__node-container"),S.value=he().extent([[0,0],[b.value,$.value]]).on("zoom",be),(t=L.value)==null||t.attr("viewbox",`0, 0, ${b.value}, ${$.value}`).call(S.value),re(),ne()},Fe=t=>{t.preventDefault(),!!h.value&&(h.value.scrollTop=0,h.value.scrollLeft=0)};return Ee(()=>{oe(),window.addEventListener("resize",oe),u.value.id("id").dependencies("upstream_dependencies").center([b.value/2,$.value/2]).items(k.value),Le()}),Ve(()=>{window.removeEventListener("resize",oe)}),(t,s)=>{const i=fe("radar-overflow-node"),r=fe("icon-button");return V(),te("div",{ref:(n,a)=>{a.container=n,h.value=n},class:"radar",onScroll:Fe},[rt,j("div",nt,[(V(!0),te(ye,null,Oe(I(U),([n,a])=>{var v,_;return V(),te(ye,{key:n},[((v=a.position)==null?void 0:v.nodes.size)==1?(V(),xe(He(a.data.state.state_details.child_flow_run_id?"radar-flow-run-node":"radar-node"),{key:0,id:`node-${n}`,node:a,selected:I(d).includes(a.id),class:We(["radar__node position-absolute",{"radar__node--transparent":I(d).length>0&&!I(d).includes(a.id)&&f.value!==a.id,"radar__node--deemphasized":I(d).length>0&&I(d).some(e=>a.upstreamNodes.get(e)||a.downstreamNodes.get(e))}]),collapsed:N.value.get(n),style:we({left:a.cx+"px",top:a.cy+"px"}),tabindex:"0",onToggleTree:ze,onClick:De(e=>ue(a.id),["stop"]),onKeyup:Ke(e=>ue(a.id),["space","enter"]),onMouseover:e=>le(a.id),onMouseout:e=>le(a.id)},null,8,["id","node","selected","class","collapsed","style","onClick","onKeyup","onMouseover","onMouseout"])):(V(),xe(i,{key:1,class:"position-absolute",nodes:(_=a.position)==null?void 0:_.nodes,style:we({left:a.cx+"px",top:a.cy+"px"}),tabindex:"0",onClick:e=>Re(a)},null,8,["nodes","style","onClick"]))],64)}),128))]),j("div",ot,[j("div",it,[O(r,{class:"bg--white justify-self-start mr-auto",icon:"pi-restart-line",onClick:Me}),O(r,{class:"bg--white mr-1",icon:"pi-zoom-in-line",onClick:Ie}),O(r,{class:"bg--white mr-1",icon:"pi-zoom-out-line",onClick:Te}),O(r,{class:"bg--white",icon:"pi-fullscreen-fill",onClick:ne})]),j("div",ct,[O(Ze,{class:"radar__minimap position-relative",id:T.id,transform:de.value,"collapsed-trees":N.value,radar:u.value,height:$.value,width:b.value,onDragViewport:qe,onPanToLocation:Ce},null,8,["id","transform","collapsed-trees","radar","height","width"])])])],544)}}});var ut=_e(lt,[["__scopeId","data-v-9e01452a"]]);const dt={class:"radar z-0"},vt=me({setup(T){const w=Qe(),k=E(()=>w==null?void 0:w.params.id),h=E(()=>({id:k.value})),L={radar:je.query({endpoint:Be.radar,body:h,options:{pollInterval:5e3}})},W=E(()=>{var F;return((F=L.radar.response)==null?void 0:F.value)||[]});return ee(k,()=>{!k.value||L.radar.fetch()}),(F,ae)=>(V(),te("div",dt,[O(ut,{id:I(k),items:I(W)},null,8,["id","items"])]))}});var mt=_e(vt,[["__scopeId","data-v-18cdbfba"]]);export{mt as default};
